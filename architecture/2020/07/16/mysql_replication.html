<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>[MySQL] MySQL Replication | Dev Log of Jason Ahn</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="[MySQL] MySQL Replication" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="1. MySQL Replication 특징 비동기식 (Asynchronous Replication) 1개의 Master와 n개의 Slave로 구성되어 있음 Master에서만 읽기 / 쓰기를 수행할 수 있음 Master / Slave 데이터 동기화 시간차가 있음 (쓰기가 발생하면 순차적으로 한대씩 각 DB로 복제 진행) 장애 복구시 노드간 유실되는 트랜잭션 있음 읽기만 확장 용이함 (쓰기 확장시 난점이 있음) Master 장애시 매우 크리티컬한 장애 발생 (복구 장기간 소요, 데이터 유실 위험 높음) 부분 장애시 장애 노드만 장애 발생 장애 요인 제거 후 단기간 / 순차적 정상화 MySQL의 부하 분산과 효율을 최우선으로 하는 경우 유리" />
<meta property="og:description" content="1. MySQL Replication 특징 비동기식 (Asynchronous Replication) 1개의 Master와 n개의 Slave로 구성되어 있음 Master에서만 읽기 / 쓰기를 수행할 수 있음 Master / Slave 데이터 동기화 시간차가 있음 (쓰기가 발생하면 순차적으로 한대씩 각 DB로 복제 진행) 장애 복구시 노드간 유실되는 트랜잭션 있음 읽기만 확장 용이함 (쓰기 확장시 난점이 있음) Master 장애시 매우 크리티컬한 장애 발생 (복구 장기간 소요, 데이터 유실 위험 높음) 부분 장애시 장애 노드만 장애 발생 장애 요인 제거 후 단기간 / 순차적 정상화 MySQL의 부하 분산과 효율을 최우선으로 하는 경우 유리" />
<link rel="canonical" href="https://safenumz.github.io/blog/architecture/2020/07/16/mysql_replication.html" />
<meta property="og:url" content="https://safenumz.github.io/blog/architecture/2020/07/16/mysql_replication.html" />
<meta property="og:site_name" content="Dev Log of Jason Ahn" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-07-16T00:00:00-05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="[MySQL] MySQL Replication" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2020-07-16T00:00:00-05:00","datePublished":"2020-07-16T00:00:00-05:00","description":"1. MySQL Replication 특징 비동기식 (Asynchronous Replication) 1개의 Master와 n개의 Slave로 구성되어 있음 Master에서만 읽기 / 쓰기를 수행할 수 있음 Master / Slave 데이터 동기화 시간차가 있음 (쓰기가 발생하면 순차적으로 한대씩 각 DB로 복제 진행) 장애 복구시 노드간 유실되는 트랜잭션 있음 읽기만 확장 용이함 (쓰기 확장시 난점이 있음) Master 장애시 매우 크리티컬한 장애 발생 (복구 장기간 소요, 데이터 유실 위험 높음) 부분 장애시 장애 노드만 장애 발생 장애 요인 제거 후 단기간 / 순차적 정상화 MySQL의 부하 분산과 효율을 최우선으로 하는 경우 유리","headline":"[MySQL] MySQL Replication","mainEntityOfPage":{"@type":"WebPage","@id":"https://safenumz.github.io/blog/architecture/2020/07/16/mysql_replication.html"},"url":"https://safenumz.github.io/blog/architecture/2020/07/16/mysql_replication.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/blog/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://safenumz.github.io/blog/feed.xml" title="Dev Log of Jason Ahn" /><link rel="shortcut icon" type="image/x-icon" href="/blog/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/blog/">Dev Log of Jason Ahn</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/blog/about/">About Me</a><a class="page-link" href="/blog/search/">Search</a><a class="page-link" href="/blog/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">[MySQL] MySQL Replication</h1><p class="post-meta post-meta-title"><time class="dt-published" datetime="2020-07-16T00:00:00-05:00" itemprop="datePublished">
        Jul 16, 2020
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      4 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/blog/categories/#Architecture">Architecture</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <h1 id="1-mysql-replication-특징">1. MySQL Replication 특징</h1>
<ul>
  <li>비동기식 (Asynchronous Replication)</li>
  <li>1개의 Master와 n개의 Slave로 구성되어 있음</li>
  <li>Master에서만 읽기 / 쓰기를 수행할 수 있음</li>
  <li>Master / Slave 데이터 동기화 시간차가 있음 (쓰기가 발생하면 순차적으로 한대씩 각 DB로 복제 진행)</li>
  <li>장애 복구시 노드간 유실되는 트랜잭션 있음</li>
  <li>읽기만 확장 용이함 (쓰기 확장시 난점이 있음)</li>
  <li>Master 장애시 매우 크리티컬한 장애 발생 (복구 장기간 소요, 데이터 유실 위험 높음)</li>
  <li>부분 장애시 장애 노드만 장애 발생</li>
  <li>장애 요인 제거 후 단기간 / 순차적 정상화</li>
  <li>MySQL의 부하 분산과 효율을 최우선으로 하는 경우 유리</li>
</ul>

<h2 id="1-master-역할">1) Master 역할</h2>
<ul>
  <li>웹서버로 부터 데이터 등록 / 수정 / 삭제 요청시 바이너리 로그 (Binary log)를 생성하여 Slave 서버로 전달함</li>
  <li>웹서버로부터 요청한 데이터 등록 / 수정 / 삭제 기능을 하는 DBMS로 사용</li>
</ul>

<h2 id="2-slave-역할">2) Slave 역할</h2>
<ul>
  <li>Master DBMS로부터 전달받은 바이너리 로그 (Binary log)를 데이터로 반영</li>
  <li>웹서버로부터 요청을 통해 데이터를 불러오는 DBMS로 사용</li>
</ul>

<h2 id="3-mysql-replication-주의사항">3) MySQL Replication 주의사항</h2>
<ul>
  <li>호환성을 위해 Replication을 사용하는 MySQL의 버전을 동일하게 맞추는 것이 좋음</li>
  <li>MySQL 버전이 다른 경우 반드시 Slave 서버가 상위버전이어야 함</li>
  <li>Replication을 가동시에 Master, Slave 순으로 가동시켜야 함</li>
</ul>

<h1 id="2-xtrabackup">2. XtraBackup</h1>
<ul>
  <li>Percona에서 개발한 오픈소스 MySQL 백업도구</li>
  <li>mysqldump가 테이블 생성, 데이터 쿼리에 대한 SQL 생성문을 갖는 논리적 백업이라면, XtraBackup은 엔진 데이터를 그대로 복사하는 물리적 백업 방식</li>
  <li>XtraBackup의 백업 방식은 크게 전체 백업, 증분 백업, 개별(db, table) 백업, Encrypted 백업 방식이 있음</li>
</ul>

<h2 id="1-mysqldump-vs-xtrabackup">1) mysqldump vs XtraBackup</h2>

<h2 id="2-xtrabackup-vs-innobackupex">2) xtrabackup vs innobackupex</h2>
<ul>
  <li>XtraBackup에서 innobackupex는 2.2 next major 부터 삭제된다고 명시</li>
  <li>실제로는 XtraBackup 2.4 버전까지는 유지되며 8 버전부터 삭제됨</li>
  <li>실무에서 주로 사용하는 MySQL 5.6 ~5.7 버전은 XtraBackup 2.0~2.4 버전에서 호환되기에 여기서는 innobackupex 방식 사용</li>
  <li>XtraBackup 8 버전은 MySQL 8 버전부터 호환됨</li>
</ul>

<h2 id="3-전체-백업">3) 전체 백업</h2>
<ul>
  <li>장애 시 복구 과정을 단순하게 하기 위해 증분 백업을 사용하지 않고 전체 백업을 사용함</li>
  <li>백업하는 동안에 table lock을 걸지 않으려면 –no-lock 옵션을 추가해야 함</li>
  <li>단, InnoDB table이 아닌 경우에는 일관성 없는 백업 결과가 나올 수 있음</li>
  <li>지정한 백업 경로에 테이블, 리두로그, XtraBackup 관련 테이터들이 함께 백업</li>
</ul>

<h1 id="3-사전-환경설정">3. 사전 환경설정</h1>

<h2 id="1-dependency">1) Dependency</h2>
<ul>
  <li>MySQL 5.6</li>
  <li>XtraBackup 2.4</li>
  <li>pv 1.4.6</li>
</ul>

<h2 id="2-mysql-설치">2) MySQL 설치</h2>
<ul>
  <li>생략</li>
</ul>

<h2 id="3-xtrabackup-설치">3) XtraBackup 설치</h2>
<ul>
  <li>2.4 버전 설치</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>yum <span class="nb">install</span> <span class="nt">-y</span> http://www.percona.com/downloads/percona-release/redhat/0.1-4/percona-release-0.1-4.noarch.rpm
<span class="nv">$ </span>yum list | <span class="nb">grep </span>percona
<span class="nv">$ </span>yum update <span class="nt">-y</span> percona-release
<span class="nv">$ </span>yum <span class="nb">install</span> <span class="nt">-y</span> percona-xtrabackup-24.x86_64
<span class="nv">$ </span>xtrabackup <span class="nt">--version</span>
</code></pre></div></div>

<h2 id="4-pv-설치">4) PV 설치</h2>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>yum <span class="nb">install</span> <span class="nt">-y</span> pv
</code></pre></div></div>

<h2 id="5-서버간-ssh-public-key-연결">5) 서버간 SSH Public Key 연결</h2>
<ul>
  <li>생략</li>
</ul>

<h1 id="4-mysql-replication-설정">4. MySQL Replication 설정</h1>

<h2 id="1-master-서버-설정">1) Master 서버 설정</h2>

<h3 id="mycnf-설정파일-수정">my.cnf 설정파일 수정</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>vi /etc/my.cnf
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># /etc/my.cnf</span>

<span class="o">[</span>client]
port <span class="o">=</span> &lt;mysql_port&gt;
default-character-set <span class="o">=</span> utf8

<span class="o">[</span>mysql]
default-character-set<span class="o">=</span>utf8

<span class="o">[</span>mysqld]
server-id<span class="o">=</span>1
log-bin<span class="o">=</span>mysql-bin
log-slave-updates<span class="o">=</span>1

port <span class="o">=</span> &lt;mysql_port&gt;
max_connections <span class="o">=</span> 2000
max_connect_errors <span class="o">=</span> 1000000
max_allowed_packet <span class="o">=</span> 1G
innodb_log_file_size <span class="o">=</span> 1G
innodb_buffer_pool_size <span class="o">=</span> 8G
innodb_log_file_size <span class="o">=</span> 256M
innodb_thread_concurrency <span class="o">=</span> 16
datadir <span class="o">=</span> /var/lib/mysql
socket <span class="o">=</span> /var/lib/mysql/mysql.sock


character-set-server<span class="o">=</span>utf8
collation-server<span class="o">=</span>utf8_general_ci
<span class="nv">init_connect</span><span class="o">=</span>SET collation_connection <span class="o">=</span> utf8_general_ci
<span class="nv">init_connect</span><span class="o">=</span>SET NAMES utf8

character-set-client-handshake <span class="o">=</span> FALSE
skip-character-set-client-handshake

skip-host-cache
skip-name-resolve

<span class="o">[</span>xtrabackup]
<span class="nv">datadir</span><span class="o">=</span>/var/lib/mysql

<span class="o">[</span>mysqldump]
<span class="nv">password</span><span class="o">=</span>dsldsl
default-character-set<span class="o">=</span>utf8
</code></pre></div></div>

<h3 id="mysql-재기동으로-설정파일-반영">MySQL 재기동으로 설정파일 반영</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>systemctl restart mysqld
</code></pre></div></div>

<h3 id="replication-계정-생성-및-권한-부여">Replication 계정 생성 및 권한 부여</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>mysql <span class="nt">-u</span> root <span class="nt">-p</span>
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql&gt; GRANT REPLICATION SLAVE ON <span class="k">*</span>.<span class="k">*</span> TO <span class="s1">'&lt;repl_user&gt;'</span>@<span class="s1">'%'</span> IDENTIFIED BY <span class="s1">'&lt;repl_password&gt;'</span><span class="p">;</span>
mysql&gt; GRANT REPLICATION SLAVE ON <span class="k">*</span>.<span class="k">*</span> TO <span class="s1">'&lt;repl_user&gt;'</span>@<span class="s1">'localhost'</span> IDENTIFIED BY <span class="s1">'&lt;repl_password&gt;'</span><span class="p">;</span>
mysql&gt; GRANT RELOAD, LOCK TABLES, PROCESS, REPLICATION CLIENT ON <span class="k">*</span>.<span class="k">*</span> TO <span class="s1">'&lt;repl_user&gt;'</span>@<span class="s1">'%'</span><span class="p">;</span>
mysql&gt; GRANT RELOAD, LOCK TABLES, PROCESS, REPLICATION CLIENT ON <span class="k">*</span>.<span class="k">*</span> TO <span class="s1">'&lt;repl_user&gt;'</span>@<span class="s1">'localhost'</span><span class="p">;</span>
mysql&gt; FLUSH PRIVILEGES<span class="p">;</span>
</code></pre></div></div>

<h2 id="2-slave-서버-설정">2) Slave 서버 설정</h2>

<h3 id="mycnf-설정파일-수정-1">my.cnf 설정파일 수정</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>vi /etc/my.cnf
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># /etc/my.cnf</span>

<span class="o">[</span>client]
port <span class="o">=</span> &lt;mysql_port&gt;
default-character-set <span class="o">=</span> utf8

<span class="o">[</span>mysql]
default-character-set<span class="o">=</span>utf8

<span class="o">[</span>mysqld]
server-id<span class="o">=</span>2
log-bin<span class="o">=</span>mysql-bin
log-slave-updates<span class="o">=</span>1
<span class="nv">datadir</span><span class="o">=</span>/var/lib/mysql

port <span class="o">=</span> &lt;mysql_port&gt;
max_connections <span class="o">=</span> 2000
max_connect_errors <span class="o">=</span> 1000000
max_allowed_packet <span class="o">=</span> 1G
innodb_log_file_size <span class="o">=</span> 1G
innodb_buffer_pool_size <span class="o">=</span> 8G
innodb_log_file_size <span class="o">=</span> 256M
innodb_thread_concurrency <span class="o">=</span> 16

character-set-server<span class="o">=</span>utf8
collation-server<span class="o">=</span>utf8_general_ci
<span class="nv">init_connect</span><span class="o">=</span>SET collation_connection <span class="o">=</span> utf8_general_ci
<span class="nv">init_connect</span><span class="o">=</span>SET NAMES utf8

character-set-client-handshake <span class="o">=</span> FALSE
skip-character-set-client-handshake

read-only<span class="o">=</span>1

slave-skip-errors <span class="o">=</span> 1062
skip-host-cache
skip-name-resolve

<span class="o">[</span>xtrabackup]
<span class="nv">datadir</span><span class="o">=</span>/var/lib/mysql

<span class="o">[</span>mysqldump]
<span class="nv">password</span><span class="o">=</span>&lt;password&gt;
default-character-set<span class="o">=</span>utf8
</code></pre></div></div>

<h3 id="백업-폴더-생성">백업 폴더 생성</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">mkdir</span> <span class="nt">-p</span> /data/mysql_backup/2020-07-16_11-00-00
<span class="nv">$ </span><span class="nb">cd</span> /data/mysql_backup/2020-07-16_11-00-00
</code></pre></div></div>

<h3 id="xtrabackup을-이용하여-master를-백업하여-slave로-가져옴">XtraBackup을 이용하여 Master를 백업하여 Slave로 가져옴</h3>
<ul>
  <li><code class="language-plaintext highlighter-rouge">--no-lock</code> 옵션이 있어야 운영 중단 없이 백업 가능</li>
  <li>innobackupex.log에는 “completed OK!”로 끝이 나야 하며, xbstream.log에는 아무 내용도 없어야 함</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ssh <span class="nt">-o</span> <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no root@&lt;master_ip&gt; <span class="nt">-p</span> &lt;master_port&gt; <span class="s2">"innobackupex --host=127.0.0.1 --user=&lt;repl_user&gt; --password=&lt;repl_password&gt; --no-lock --stream=xbstream /data/mysql_backup/2020-07-16_11-00-00 | pv --rate-limit 50000000"</span> 2&gt; innobackupex.log | xbstream <span class="nt">-x</span> 2&gt; xbstream.log
</code></pre></div></div>

<h3 id="데이터-복구-준비">데이터 복구 준비</h3>
<ul>
  <li>백업이 특정 시점에 완벽하게 이뤄진다면 좋겠지만 데이터의 크기와 서버의 성능에 따라 백업하는 시간이 수십 시간까지도 소요될 수 있음</li>
  <li>백업하는 중에 INSERT, UPDATE, DELETE 쿼리가 유입되면 백업된 데이터의 일관성이 사라질 수 있음</li>
  <li>복원 준비 단계에서는 백업 중 수행된 트랜잭션 로그파일(xtrabackup_logfile)을 적용하여 데이터를 일관성 있게 만들어 줌</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>innobackupex <span class="nt">--defaults-file</span><span class="o">=</span>/etc/my.cnf <span class="nt">--apply-log</span> /data/mysql_backup/2020-07-16_11-00-00  2&gt;&gt; innobackupex.log
</code></pre></div></div>

<h3 id="master의-binary-log-파일과-위치를-기록해둠">Master의 binary log 파일과 위치를 기록해둠</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># file</span>
<span class="nv">$ </span><span class="nb">sed</span> <span class="nt">-r</span> <span class="s2">"s/^(.*)</span><span class="se">\s</span><span class="s2">+([0-9]+)/</span><span class="se">\1</span><span class="s2">/g"</span> xtrabackup_binlog_info

<span class="c"># position</span>
<span class="nv">$ </span><span class="nb">sed</span> <span class="nt">-r</span> <span class="s2">"s/^(.*)</span><span class="se">\s</span><span class="s2">+([0-9]+)/</span><span class="se">\2</span><span class="s2">/g"</span> xtrabackup_binlog_info
</code></pre></div></div>

<h3 id="mysql-중지">MySQL 중지</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>systemctl stop mysqld
</code></pre></div></div>

<h3 id="기존-mysql-파일-백업">기존 MySQL 파일 백업</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">mkdir</span> <span class="nt">-p</span> /data/mysql_backup/native
<span class="nv">$ </span>/bin/cp <span class="nt">-r</span> /var/lib/mysql/<span class="k">*</span> /data/mysql_backup/native
</code></pre></div></div>

<h3 id="기존-mysql-파일-삭제">기존 MySQL 파일 삭제</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">rm</span> <span class="nt">-rf</span> /var/lib/mysql/<span class="k">*</span>
</code></pre></div></div>

<h3 id="복원">복원</h3>
<ul>
  <li>준비된 Master의 백업 파일을 Slave의 datadir로 옮겨줌</li>
  <li><code class="language-plaintext highlighter-rouge">--copy-back</code> 명령어를 사용하면 백업된 내용을 원본 디렉토리 (/var/log/mysql)에 이동시켜 줌</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>innobackupex <span class="nt">--defaults-file</span><span class="o">=</span>/etc/my.cnf <span class="nt">--copy-back</span> /data/mysql_backup/2020-07-16_11-00-00
</code></pre></div></div>

<h3 id="mysql-파일이-재대로-들어왔는지-확인">MySQL 파일이 재대로 들어왔는지 확인</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-al</span> /var/lib/mysql
</code></pre></div></div>

<h3 id="mysql-권한-재설정">MySQL 권한 재설정</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cd</span> /var/lib/mysql
<span class="nv">$ </span><span class="nb">chown</span> <span class="nt">-R</span> mysql:mysql <span class="k">*</span>
<span class="nv">$ </span><span class="nb">chmod </span>g+w /var/run/mysqld/
<span class="nv">$ </span><span class="nb">chgrp </span>mysql /var/run/mysqld/
</code></pre></div></div>

<h3 id="mysql-재기동">MySQL 재기동</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>systemctl stop mysqld
<span class="nv">$ </span>systemctl start mysqld
</code></pre></div></div>

<h3 id="slave에-master-정보-등록">Slave에 Master 정보 등록</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>mysql <span class="nt">-uroot</span> <span class="nt">-p</span>
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># slave 초기화</span>
mysql&gt; stop slave<span class="p">;</span>
mysql&gt; reset slave all<span class="p">;</span>

<span class="c"># 마스터 설정</span>
mysql&gt; change master to <span class="nv">master_host</span><span class="o">=</span><span class="s1">'&lt;master_ip&gt;'</span>, <span class="nv">master_user</span><span class="o">=</span><span class="s1">'&lt;repl_user&gt;'</span>, <span class="nv">master_port</span><span class="o">=</span>&lt;master_port&gt;, <span class="nv">master_password</span><span class="o">=</span><span class="s1">'&lt;repl_password&gt;'</span>, <span class="nv">master_log_file</span><span class="o">=</span><span class="s1">'&lt;master_binary_log_file&gt;'</span>, <span class="nv">master_log_pos</span><span class="o">=</span>&lt;master_binary_log_position&gt;<span class="p">;</span>

mysql&gt; show slave status <span class="se">\G</span>

mysql&gt; start slave<span class="p">;</span>

mysql&gt; show slave status <span class="se">\G</span>
</code></pre></div></div>


  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="safenumz/blog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/blog/architecture/2020/07/16/mysql_replication.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/blog/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/blog/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/blog/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>AI and Data Engineering</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/https%3A%2F%2Fgithub.com%2Fsafenumz" target="_blank" title="https://github.com/safenumz"><svg class="svg-icon grey"><use xlink:href="/blog/assets/minima-social-icons.svg#github"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
