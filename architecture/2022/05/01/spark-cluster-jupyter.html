<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>[Spark] PySpark Cluster 구축 및 Jupyter lab 세팅 | Dev Log of Jason Ahn</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="[Spark] PySpark Cluster 구축 및 Jupyter lab 세팅" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Environment" />
<meta property="og:description" content="Environment" />
<link rel="canonical" href="https://safenumz.github.io/blog/architecture/2022/05/01/spark-cluster-jupyter.html" />
<meta property="og:url" content="https://safenumz.github.io/blog/architecture/2022/05/01/spark-cluster-jupyter.html" />
<meta property="og:site_name" content="Dev Log of Jason Ahn" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-05-01T00:00:00-05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="[Spark] PySpark Cluster 구축 및 Jupyter lab 세팅" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-05-01T00:00:00-05:00","datePublished":"2022-05-01T00:00:00-05:00","description":"Environment","headline":"[Spark] PySpark Cluster 구축 및 Jupyter lab 세팅","mainEntityOfPage":{"@type":"WebPage","@id":"https://safenumz.github.io/blog/architecture/2022/05/01/spark-cluster-jupyter.html"},"url":"https://safenumz.github.io/blog/architecture/2022/05/01/spark-cluster-jupyter.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/blog/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://safenumz.github.io/blog/feed.xml" title="Dev Log of Jason Ahn" /><link rel="shortcut icon" type="image/x-icon" href="/blog/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/blog/">Dev Log of Jason Ahn</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/blog/about/">About Me</a><a class="page-link" href="/blog/search/">Search</a><a class="page-link" href="/blog/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">[Spark] PySpark Cluster 구축 및 Jupyter lab 세팅</h1><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-05-01T00:00:00-05:00" itemprop="datePublished">
        May 1, 2022
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      8 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/blog/categories/#Architecture">Architecture</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <h1 id="environment">Environment</h1>

<table>
  <thead>
    <tr>
      <th style="text-align: center">Role</th>
      <th style="text-align: center">IP</th>
      <th style="text-align: center">HostName</th>
      <th style="text-align: center">OS</th>
      <th style="text-align: center">Ram</th>
      <th style="text-align: center">CoreNum</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">Client</td>
      <td style="text-align: center">192.168.0.99</td>
      <td style="text-align: center">lab</td>
      <td style="text-align: center">MacOS</td>
      <td style="text-align: center">16G</td>
      <td style="text-align: center">12</td>
    </tr>
    <tr>
      <td style="text-align: center">Master</td>
      <td style="text-align: center">192.168.0.100</td>
      <td style="text-align: center">lab100</td>
      <td style="text-align: center">CentOS 7</td>
      <td style="text-align: center">16G</td>
      <td style="text-align: center">8</td>
    </tr>
    <tr>
      <td style="text-align: center">Worker</td>
      <td style="text-align: center">192.168.0.101</td>
      <td style="text-align: center">lab101</td>
      <td style="text-align: center">CentOS 7</td>
      <td style="text-align: center">32G</td>
      <td style="text-align: center">8</td>
    </tr>
    <tr>
      <td style="text-align: center">Worker</td>
      <td style="text-align: center">192.168.0.102</td>
      <td style="text-align: center">lab102</td>
      <td style="text-align: center">CentOS 7</td>
      <td style="text-align: center">32G</td>
      <td style="text-align: center">8</td>
    </tr>
    <tr>
      <td style="text-align: center">Worker</td>
      <td style="text-align: center">192.168.0.103</td>
      <td style="text-align: center">lab103</td>
      <td style="text-align: center">CentOS 7</td>
      <td style="text-align: center">32G</td>
      <td style="text-align: center">8</td>
    </tr>
    <tr>
      <td style="text-align: center">Worker</td>
      <td style="text-align: center">192.168.0.104</td>
      <td style="text-align: center">lab104</td>
      <td style="text-align: center">CentOS 7</td>
      <td style="text-align: center">32G</td>
      <td style="text-align: center">8</td>
    </tr>
    <tr>
      <td style="text-align: center">Worker</td>
      <td style="text-align: center">192.168.0.105</td>
      <td style="text-align: center">lab105</td>
      <td style="text-align: center">CentOS 7</td>
      <td style="text-align: center">32G</td>
      <td style="text-align: center">8</td>
    </tr>
    <tr>
      <td style="text-align: center">Worker</td>
      <td style="text-align: center">192.168.0.106</td>
      <td style="text-align: center">lab106</td>
      <td style="text-align: center">CentOS 7</td>
      <td style="text-align: center">32G</td>
      <td style="text-align: center">8</td>
    </tr>
    <tr>
      <td style="text-align: center">Worker</td>
      <td style="text-align: center">192.168.0.107</td>
      <td style="text-align: center">lab107</td>
      <td style="text-align: center">CentOS 7</td>
      <td style="text-align: center">32G</td>
      <td style="text-align: center">8</td>
    </tr>
    <tr>
      <td style="text-align: center">Worker</td>
      <td style="text-align: center">192.168.0.108</td>
      <td style="text-align: center">lab106</td>
      <td style="text-align: center">CentOS 7</td>
      <td style="text-align: center">32G</td>
      <td style="text-align: center">8</td>
    </tr>
    <tr>
      <td style="text-align: center">Worker</td>
      <td style="text-align: center">192.168.0.109</td>
      <td style="text-align: center">lab107</td>
      <td style="text-align: center">CentOS 7</td>
      <td style="text-align: center">32G</td>
      <td style="text-align: center">8</td>
    </tr>
  </tbody>
</table>

<h2 id="client-master-woker-hosts-설정">Client, Master, Woker: hosts 설정</h2>
<ul>
  <li>지금 다시 생각해 보니까 Client를 MacOS로 하는 건 jars 들을 불러올 때 좋지 않음. 각종 버그가 발생할 수 있음. 그냥 동일한 리눅스로 맞춰주는 게 가장 무난.</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>vi /etc/hosts
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># /etc/hosts</span>

192.168.0.99   lab
192.168.0.100   lab100
192.168.0.101   lab101
192.168.0.102   lab102
192.168.0.103   lab103
192.168.0.104   lab104
192.168.0.105   lab105
192.168.0.106   lab106
192.168.0.107   lab107
192.168.0.108   lab108
192.168.0.109   lab109
</code></pre></div></div>

<h2 id="client-master-woker-모든-서버가-ssh-패스워드-없이-접속가능해야-함">Client, Master, Woker: 모든 서버가 ssh 패스워드 없이 접속가능해야 함</h2>
<ul>
  <li>모든 서버에 ssh public key를 공유하는 건 매우 번거로운 일이라 간단한 스크립트 작성하여 실행함</li>
</ul>

<h3 id="스크립트-실행-전-주의-사항">스크립트 실행 전 주의 사항</h3>
<ul>
  <li>CLIENT SERVER에서 실행</li>
  <li>개인 테스트용으로 만든 스크립트로 운영용이 아님, 운영용으로 만들기 위해서는 더 옵션들을 추가할 필요</li>
  <li>전 서버에서 sudo 없이 yum command 사용 가능하게 설정해 놓거나, 아니면 사전에 전 서버에 sshpass를 설치해야 함 <strong>yum install sshpass -y</strong></li>
  <li>전 서버의 ~/.ssh/authorized_keys 파일에 대해 쓰기 권한이 있어야 함 (일반적으로 400으로 권한 설정해 놓는데 일시적으로 777로 풀어줘야 함)</li>
  <li>공개키를 새로 생성해서 overwrite하는 방식이라 스크립트를 돌리면 기존 public key는 사용 못하게 됨, 추후 수정 필요</li>
</ul>

<h3 id="스크립트-실행">스크립트 실행</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bash setup_ssh.sh <span class="nv">$PWD</span>/ssh_config.sh
</code></pre></div></div>

<h3 id="ssh_configsh">ssh_config.sh</h3>
<ul>
  <li>서버 정보 설정</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="c"># CLIENT=(user  ip  password  port nickname)</span>
<span class="c"># Available OS: CentOS, Ubuntu, Mac</span>
<span class="c"># CLIENT=(a 192.168.0.99 &lt;password&gt; 22 lab)</span>

<span class="c"># SERVER=(user  ip  password  port nickname)</span>
<span class="c"># Available OS: CentOS, Ubuntu</span>
<span class="nv">SERVER_0</span><span class="o">=(</span>a 192.168.0.99 &lt;password&gt; 22 lab<span class="o">)</span>
<span class="nv">SERVER_1</span><span class="o">=(</span>a 192.168.0.100 &lt;password&gt; 22 lab100<span class="o">)</span>
<span class="nv">SERVER_2</span><span class="o">=(</span>a 192.168.0.101 &lt;password&gt; 22 lab101<span class="o">)</span>
<span class="nv">SERVER_3</span><span class="o">=(</span>a 192.168.0.102 &lt;password&gt; 22 lab102<span class="o">)</span>
<span class="nv">SERVER_4</span><span class="o">=(</span>a 192.168.0.103 &lt;password&gt; 22 lab103<span class="o">)</span>
<span class="nv">SERVER_5</span><span class="o">=(</span>a 192.168.0.104 &lt;password&gt; 22 lab104<span class="o">)</span>
<span class="nv">SERVER_6</span><span class="o">=(</span>a 192.168.0.105 &lt;password&gt; 22 lab105<span class="o">)</span>
<span class="nv">SERVER_7</span><span class="o">=(</span>a 192.168.0.106 &lt;password&gt; 22 lab106<span class="o">)</span>
<span class="nv">SERVER_8</span><span class="o">=(</span>a 192.168.0.107 &lt;password&gt; 22 lab107<span class="o">)</span>
<span class="nv">SERVER_9</span><span class="o">=(</span>a 192.168.0.108 &lt;password&gt; 22 lab108<span class="o">)</span>
<span class="nv">SERVER_10</span><span class="o">=(</span>a 192.168.0.109 &lt;password&gt; 22 lab109<span class="o">)</span>

<span class="nv">SERVER_LIST</span><span class="o">=(</span>
    SERVER_0[@]
    SERVER_1[@]
    SERVER_2[@]
    SERVER_3[@]
    SERVER_4[@]
    SERVER_5[@]
    SERVER_6[@]
    SERVER_7[@]
    SERVER_8[@]
    SERVER_9[@]
    SERVER_10[@]
<span class="o">)</span>
</code></pre></div></div>

<h3 id="setup_sshsh">setup_ssh.sh</h3>
<ul>
  <li>ssh_config.sh의 서버 정보를 불러들어와서 전 서버를 돌면서 public key를 서로 공유함</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="c"># ===========================================================================</span>
<span class="c"># Program: setup_ssh.sh</span>
<span class="c">#    Path: .</span>
<span class="c">#   Usage: bash setup_ssh.sh $1</span>
<span class="c">#      $1: $PWD/ssh_config.sh</span>
<span class="c"># ============================================================================</span>

<span class="nb">source</span> <span class="nv">$1</span>

<span class="k">function </span>remote_cmd<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">user</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">ip</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nb">local </span><span class="nv">passwd</span><span class="o">=</span><span class="nv">$3</span>
    <span class="nb">local </span><span class="nv">port</span><span class="o">=</span><span class="nv">$4</span>
    <span class="nb">local command</span><span class="o">=</span><span class="nv">$5</span>
    sshpass <span class="nt">-p</span> <span class="k">${</span><span class="nv">passwd</span><span class="k">}</span> ssh <span class="nt">-p</span> <span class="k">${</span><span class="nv">port</span><span class="k">}</span> <span class="nt">-o</span> <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no <span class="k">${</span><span class="nv">user</span><span class="k">}</span>@<span class="k">${</span><span class="nv">ip</span><span class="k">}</span> <span class="s2">"export PATH=</span><span class="nv">$PATH</span><span class="s2">:/usr/local/bin:/usr/bin &amp;&amp; </span><span class="k">${</span><span class="nv">command</span><span class="k">}</span><span class="s2">"</span>
<span class="o">}</span>

<span class="k">function </span>install_sshpass<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">user</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">ip</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nb">local </span><span class="nv">passwd</span><span class="o">=</span><span class="nv">$3</span>
    <span class="nb">local </span><span class="nv">port</span><span class="o">=</span><span class="nv">$4</span>

    <span class="nb">echo</span> <span class="s2">"install-sshpass </span><span class="k">${</span><span class="nv">ip</span><span class="k">}</span><span class="s2">:</span><span class="k">${</span><span class="nv">port</span><span class="k">}</span><span class="s2">"</span>

    <span class="k">if</span> <span class="o">[[</span> <span class="si">$(</span>remote_cmd <span class="s2">"</span><span class="nv">$user</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$ip</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$passwd</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$port</span><span class="s2">"</span> <span class="s2">"cat /etc/*release"</span><span class="si">)</span> <span class="o">=</span>~ <span class="s2">"CentOS"</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
        </span>remote_cmd <span class="s2">"</span><span class="nv">$user</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$ip</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$passwd</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$port</span><span class="s2">"</span> <span class="s2">"yum install -y sshpass"</span>
    <span class="k">elif</span> <span class="o">[[</span> <span class="si">$(</span>remote_cmd <span class="s2">"</span><span class="nv">$user</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$ip</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$passwd</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$port</span><span class="s2">"</span> <span class="s2">"cat /etc/*release"</span><span class="si">)</span> <span class="o">=</span>~ <span class="s2">"Ubuntu"</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
        </span>remote_cmd <span class="s2">"</span><span class="nv">$user</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$ip</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$passwd</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$port</span><span class="s2">"</span> <span class="s2">"apt-get install -y sshpass"</span>
    <span class="k">else
        </span><span class="nb">echo</span> <span class="s2">"[WARNING] Invalid OS... (Valid OS: CentOS, Ubuntu)"</span>
    <span class="k">fi</span>
<span class="o">}</span>

<span class="k">function </span>ssh_keygen<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">user</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">ip</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nb">local </span><span class="nv">passwd</span><span class="o">=</span><span class="nv">$3</span>
    <span class="nb">local </span><span class="nv">port</span><span class="o">=</span><span class="nv">$4</span>
    <span class="nb">local </span><span class="nv">nickname</span><span class="o">=</span><span class="nv">$5</span>

    <span class="nb">echo</span> <span class="s2">"*** ssh-keygen </span><span class="k">${</span><span class="nv">nickname</span><span class="k">}</span><span class="s2">(</span><span class="k">${</span><span class="nv">user</span><span class="k">}</span><span class="s2">@</span><span class="k">${</span><span class="nv">ip</span><span class="k">}</span><span class="s2">:</span><span class="k">${</span><span class="nv">port</span><span class="k">}</span><span class="s2">)"</span>

    remote_cmd <span class="s2">"</span><span class="nv">$user</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$ip</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$passwd</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$port</span><span class="s2">"</span> <span class="s2">"ssh-keygen -t rsa -P '' -f ~/.ssh/id_rsa &amp;&amp;  cat ~/.ssh/id_rsa.pub &gt;&gt; ~/.ssh/authorized_keys"</span> <span class="o">&lt;&lt;&lt;</span> y <span class="o">&gt;</span> /dev/null

<span class="o">}</span>

<span class="k">function </span>share_ssh_key<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">src_user</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">src_ip</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nb">local </span><span class="nv">src_passwd</span><span class="o">=</span><span class="nv">$3</span>
    <span class="nb">local </span><span class="nv">src_port</span><span class="o">=</span><span class="nv">$4</span>
    <span class="nb">local </span><span class="nv">src_nickname</span><span class="o">=</span><span class="nv">$5</span>
    <span class="nb">local </span><span class="nv">dst_user</span><span class="o">=</span><span class="nv">$6</span>
    <span class="nb">local </span><span class="nv">dst_ip</span><span class="o">=</span><span class="nv">$7</span>
    <span class="nb">local </span><span class="nv">dst_passwd</span><span class="o">=</span><span class="nv">$8</span>
    <span class="nb">local </span><span class="nv">dst_port</span><span class="o">=</span><span class="nv">$9</span>
    <span class="nb">local </span><span class="nv">dst_nickname</span><span class="o">=</span><span class="nv">$10</span>
    <span class="nb">local </span><span class="nv">dst_home</span><span class="o">=</span><span class="si">$(</span>remote_cmd <span class="s2">"</span><span class="nv">$dst_user</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$dst_ip</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$dst_passwd</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$dst_port</span><span class="s2">"</span> <span class="s2">"echo </span><span class="se">\$</span><span class="s2">HOME"</span><span class="si">)</span>

    <span class="nb">echo</span> <span class="s2">"*** share ssh-key </span><span class="k">${</span><span class="nv">src_nickname</span><span class="k">}</span><span class="s2">(</span><span class="k">${</span><span class="nv">src_user</span><span class="k">}</span><span class="s2">@</span><span class="k">${</span><span class="nv">src_ip</span><span class="k">}</span><span class="s2">:</span><span class="k">${</span><span class="nv">src_port</span><span class="k">}</span><span class="s2">) -&gt; </span><span class="k">${</span><span class="nv">dst_nickname</span><span class="k">}</span><span class="s2">(</span><span class="k">${</span><span class="nv">dst_user</span><span class="k">}</span><span class="s2">@</span><span class="k">${</span><span class="nv">dst_ip</span><span class="k">}</span><span class="s2">:</span><span class="k">${</span><span class="nv">dst_port</span><span class="k">}</span><span class="s2">)"</span>
    <span class="nb">echo</span> <span class="s2">"sshpass -p </span><span class="k">${</span><span class="nv">dst_passwd</span><span class="k">}</span><span class="s2"> scp -P </span><span class="k">${</span><span class="nv">dst_port</span><span class="k">}</span><span class="s2"> -o StrictHostKeyChecking=no ~/.ssh/id_rsa.pub </span><span class="k">${</span><span class="nv">dst_user</span><span class="k">}</span><span class="s2">@</span><span class="k">${</span><span class="nv">dst_ip</span><span class="k">}</span><span class="s2">:/</span><span class="k">${</span><span class="nv">dst_home</span><span class="k">}</span><span class="s2">/.ssh/</span><span class="k">${</span><span class="nv">src_nickname</span><span class="k">}</span><span class="s2">.pub"</span>

    remote_cmd <span class="s2">"</span><span class="nv">$src_user</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$src_ip</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$src_passwd</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$src_port</span><span class="s2">"</span> <span class="s2">"sshpass -p </span><span class="k">${</span><span class="nv">dst_passwd</span><span class="k">}</span><span class="s2"> scp -P </span><span class="k">${</span><span class="nv">dst_port</span><span class="k">}</span><span class="s2"> -o StrictHostKeyChecking=no ~/.ssh/id_rsa.pub </span><span class="k">${</span><span class="nv">dst_user</span><span class="k">}</span><span class="s2">@</span><span class="k">${</span><span class="nv">dst_ip</span><span class="k">}</span><span class="s2">:/</span><span class="k">${</span><span class="nv">dst_home</span><span class="k">}</span><span class="s2">/.ssh/</span><span class="k">${</span><span class="nv">src_nickname</span><span class="k">}</span><span class="s2">.pub"</span>

    remote_cmd <span class="s2">"</span><span class="nv">$dst_user</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$dst_ip</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$dst_passwd</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$dst_port</span><span class="s2">"</span> <span class="s2">"cat ~/.ssh/</span><span class="k">${</span><span class="nv">src_nickname</span><span class="k">}</span><span class="s2">.pub &gt;&gt; ~/.ssh/authorized_keys"</span>
<span class="o">}</span>

<span class="k">function </span>set_authority<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">user</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">ip</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nb">local </span><span class="nv">passwd</span><span class="o">=</span><span class="nv">$3</span>
    <span class="nb">local </span><span class="nv">port</span><span class="o">=</span><span class="nv">$4</span>
    <span class="nb">local </span><span class="nv">nickname</span><span class="o">=</span><span class="nv">$5</span>

    <span class="nb">echo</span> <span class="s2">"set authority </span><span class="k">${</span><span class="nv">nickname</span><span class="k">}</span><span class="s2">(</span><span class="k">${</span><span class="nv">user</span><span class="k">}</span><span class="s2">@</span><span class="k">${</span><span class="nv">ip</span><span class="k">}</span><span class="s2">:</span><span class="k">${</span><span class="nv">port</span><span class="k">}</span><span class="s2">)"</span>

    remote_cmd <span class="s2">"</span><span class="nv">$user</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$ip</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$passwd</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$port</span><span class="s2">"</span> <span class="s2">"chmod 400 ~/.ssh/authorized_keys"</span>
<span class="o">}</span>

<span class="k">function </span>validate_ssh_conn<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">src_user</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">src_ip</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nb">local </span><span class="nv">src_passwd</span><span class="o">=</span><span class="nv">$3</span>
    <span class="nb">local </span><span class="nv">src_port</span><span class="o">=</span><span class="nv">$4</span>
    <span class="nb">local </span><span class="nv">src_nickname</span><span class="o">=</span><span class="nv">$5</span>
    <span class="nb">local </span><span class="nv">dst_user</span><span class="o">=</span><span class="nv">$6</span>
    <span class="nb">local </span><span class="nv">dst_ip</span><span class="o">=</span><span class="nv">$7</span>
    <span class="nb">local </span><span class="nv">dst_port</span><span class="o">=</span><span class="nv">$8</span>
    <span class="nb">local </span><span class="nv">dst_nickname</span><span class="o">=</span><span class="nv">$9</span>

    <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">*** validate ssh-connection </span><span class="k">${</span><span class="nv">src_nickname</span><span class="k">}</span><span class="s2">(</span><span class="k">${</span><span class="nv">src_user</span><span class="k">}</span><span class="s2">@</span><span class="k">${</span><span class="nv">src_ip</span><span class="k">}</span><span class="s2">:</span><span class="k">${</span><span class="nv">src_port</span><span class="k">}</span><span class="s2">) -&gt; </span><span class="k">${</span><span class="nv">dst_nickname</span><span class="k">}</span><span class="s2">(</span><span class="k">${</span><span class="nv">dst_user</span><span class="k">}</span><span class="s2">@</span><span class="k">${</span><span class="nv">dst_ip</span><span class="k">}</span><span class="s2">:</span><span class="k">${</span><span class="nv">dst_port</span><span class="k">}</span><span class="s2">)"</span>

    remote_cmd <span class="s2">"</span><span class="nv">$src_user</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$src_ip</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$src_passwd</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$src_port</span><span class="s2">"</span> <span class="s2">"ssh </span><span class="k">${</span><span class="nv">dst_user</span><span class="k">}</span><span class="s2">@</span><span class="k">${</span><span class="nv">dst_ip</span><span class="k">}</span><span class="s2"> -p </span><span class="k">${</span><span class="nv">dst_port</span><span class="k">}</span><span class="s2"> 'echo 2&gt;&amp;1' &amp;&amp; echo '[SSH CONNECTION SUCCESS] </span><span class="k">${</span><span class="nv">src_nickname</span><span class="k">}</span><span class="s2">(</span><span class="k">${</span><span class="nv">src_user</span><span class="k">}</span><span class="s2">@</span><span class="k">${</span><span class="nv">src_ip</span><span class="k">}</span><span class="s2">:</span><span class="k">${</span><span class="nv">src_port</span><span class="k">}</span><span class="s2">) -&gt; </span><span class="k">${</span><span class="nv">dst_nickname</span><span class="k">}</span><span class="s2">(</span><span class="k">${</span><span class="nv">dst_user</span><span class="k">}</span><span class="s2">@</span><span class="k">${</span><span class="nv">dst_ip</span><span class="k">}</span><span class="s2">:</span><span class="k">${</span><span class="nv">dst_port</span><span class="k">}</span><span class="s2">)' || echo '[SSH CONNECTION FAILURE] </span><span class="k">${</span><span class="nv">src_nickname</span><span class="k">}</span><span class="s2">(</span><span class="k">${</span><span class="nv">src_user</span><span class="k">}</span><span class="s2">@</span><span class="k">${</span><span class="nv">src_ip</span><span class="k">}</span><span class="s2">:</span><span class="k">${</span><span class="nv">src_port</span><span class="k">}</span><span class="s2">) -&gt; </span><span class="k">${</span><span class="nv">dst_user</span><span class="k">}</span><span class="s2">@</span><span class="k">${</span><span class="nv">dst_nickname</span><span class="k">}</span><span class="s2">(</span><span class="k">${</span><span class="nv">dst_ip</span><span class="k">}</span><span class="s2">:</span><span class="k">${</span><span class="nv">dst_port</span><span class="k">}</span><span class="s2">)'"</span>

<span class="o">}</span>

<span class="k">function </span>main<span class="o">()</span> <span class="o">{</span>
    <span class="c"># client</span>
    <span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-z</span> <span class="nv">$CLIENT</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"CLIENT SETTING 1"</span>
        ssh-keygen <span class="nt">-t</span> rsa <span class="nt">-P</span> <span class="s1">''</span> <span class="nt">-f</span> ~/.ssh/id_rsa <span class="o">&lt;&lt;&lt;</span> y <span class="o">&gt;</span> /dev/null
        <span class="nb">cat</span> ~/.ssh/id_rsa.pub <span class="o">&gt;&gt;</span> ~/.ssh/authorized_keys
        <span class="nb">chmod </span>400 ~/.ssh/authorized_keys
    <span class="k">fi</span>

    <span class="c"># server: sshpass 설치 및 ssh-keygen</span>
    <span class="k">for</span> <span class="o">((</span><span class="nv">i</span><span class="o">=</span>0<span class="p">;</span> i&lt;<span class="k">${#</span><span class="nv">SERVER_LIST</span><span class="p">[@]</span><span class="k">}</span><span class="p">;</span> i++<span class="o">))</span>
    <span class="k">do
        </span><span class="nb">local </span><span class="nv">user</span><span class="o">=</span><span class="k">${</span><span class="p">!SERVER_LIST[i]</span>:0:1<span class="k">}</span>
        <span class="nb">local </span><span class="nv">ip</span><span class="o">=</span><span class="k">${</span><span class="p">!SERVER_LIST[i]</span>:1:1<span class="k">}</span>
        <span class="nb">local </span><span class="nv">passwd</span><span class="o">=</span><span class="k">${</span><span class="p">!SERVER_LIST[i]</span>:2:1<span class="k">}</span>
        <span class="nb">local </span><span class="nv">port</span><span class="o">=</span><span class="k">${</span><span class="p">!SERVER_LIST[i]</span>:3:1<span class="k">}</span>
        <span class="nb">local </span><span class="nv">nickname</span><span class="o">=</span><span class="k">${</span><span class="p">!SERVER_LIST[i]</span>:4:1<span class="k">}</span>
        <span class="c"># sshpass 설치</span>
        install_sshpass <span class="s2">"</span><span class="nv">$user</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$ip</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$passwd</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$port</span><span class="s2">"</span>
        <span class="c"># ssh-keygen</span>
        ssh_keygen <span class="s2">"</span><span class="nv">$user</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$ip</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$passwd</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$port</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$nickname</span><span class="s2">"</span>
    <span class="k">done</span>

    <span class="c"># server: 각 서버 간 public key 공유</span>
    <span class="k">for</span> <span class="o">((</span><span class="nv">i</span><span class="o">=</span>0<span class="p">;</span> i&lt;<span class="k">${#</span><span class="nv">SERVER_LIST</span><span class="p">[@]</span><span class="k">}</span><span class="p">;</span> i++<span class="o">))</span>
    <span class="k">do
        </span><span class="nb">local </span><span class="nv">src_user</span><span class="o">=</span><span class="k">${</span><span class="p">!SERVER_LIST[i]</span>:0:1<span class="k">}</span>
        <span class="nb">local </span><span class="nv">src_ip</span><span class="o">=</span><span class="k">${</span><span class="p">!SERVER_LIST[i]</span>:1:1<span class="k">}</span>
        <span class="nb">local </span><span class="nv">src_passwd</span><span class="o">=</span><span class="k">${</span><span class="p">!SERVER_LIST[i]</span>:2:1<span class="k">}</span>
        <span class="nb">local </span><span class="nv">src_port</span><span class="o">=</span><span class="k">${</span><span class="p">!SERVER_LIST[i]</span>:3:1<span class="k">}</span>
        <span class="nb">local </span><span class="nv">src_nickname</span><span class="o">=</span><span class="k">${</span><span class="p">!SERVER_LIST[i]</span>:4:1<span class="k">}</span>

        <span class="c"># client</span>
        <span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-z</span> <span class="nv">$CLIENT</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
            </span><span class="nb">echo</span> <span class="s2">"CLIENT SETTING 2"</span>
            <span class="nb">local </span><span class="nv">client_nickname</span><span class="o">=</span><span class="k">${</span><span class="nv">CLIENT</span><span class="p">[4]</span><span class="k">}</span>
            sshpass <span class="nt">-p</span> <span class="s2">"</span><span class="nv">$src_passwd</span><span class="s2">"</span> scp <span class="nt">-P</span> <span class="s2">"</span><span class="nv">$src_port</span><span class="s2">"</span> <span class="nt">-o</span> <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no ~/.ssh/id_rsa.pub <span class="s2">"</span><span class="k">${</span><span class="nv">src_user</span><span class="k">}</span><span class="s2">"</span>@<span class="s2">"</span><span class="k">${</span><span class="nv">src_ip</span><span class="k">}</span><span class="s2">"</span>:/<span class="si">$(</span><span class="nb">echo</span> <span class="se">\$</span>HOME<span class="si">)</span>/.ssh/<span class="k">${</span><span class="nv">client_nickname</span><span class="k">}</span>.pub
            remote_cmd <span class="s2">"</span><span class="nv">$src_user</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$src_ip</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$src_passwd</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$src_port</span><span class="s2">"</span> <span class="s2">"cat ~/.ssh/</span><span class="k">${</span><span class="nv">client_nickname</span><span class="k">}</span><span class="s2">.pub &gt;&gt; ~/.ssh/authorized_keys"</span>
        <span class="k">fi

        for</span> <span class="o">((</span><span class="nv">j</span><span class="o">=</span>0<span class="p">;</span> j&lt;<span class="k">${#</span><span class="nv">SERVER_LIST</span><span class="p">[@]</span><span class="k">}</span><span class="p">;</span> j++<span class="o">))</span>
        <span class="k">do
            </span><span class="nb">local </span><span class="nv">dst_user</span><span class="o">=</span><span class="k">${</span><span class="p">!SERVER_LIST[j]</span>:0:1<span class="k">}</span>
            <span class="nb">local </span><span class="nv">dst_ip</span><span class="o">=</span><span class="k">${</span><span class="p">!SERVER_LIST[j]</span>:1:1<span class="k">}</span>
            <span class="nb">local </span><span class="nv">dst_passwd</span><span class="o">=</span><span class="k">${</span><span class="p">!SERVER_LIST[j]</span>:2:1<span class="k">}</span>
            <span class="nb">local </span><span class="nv">dst_port</span><span class="o">=</span><span class="k">${</span><span class="p">!SERVER_LIST[j]</span>:3:1<span class="k">}</span>
            <span class="nb">local </span><span class="nv">dst_nickname</span><span class="o">=</span><span class="k">${</span><span class="p">!SERVER_LIST[j]</span>:4:1<span class="k">}</span>
            <span class="k">if</span> <span class="o">[[</span> <span class="s2">"</span><span class="k">${</span><span class="nv">src_ip</span><span class="k">}</span><span class="s2">:</span><span class="k">${</span><span class="nv">src_port</span><span class="k">}</span><span class="s2">"</span> <span class="o">!=</span> <span class="s2">"</span><span class="k">${</span><span class="nv">dst_ip</span><span class="k">}</span><span class="s2">:</span><span class="k">${</span><span class="nv">dst_port</span><span class="k">}</span><span class="s2">"</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
                    </span>share_ssh_key <span class="s2">"</span><span class="nv">$src_user</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$src_ip</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$src_passwd</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$src_port</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$src_nickname</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$dst_user</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$dst_ip</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$dst_passwd</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$dst_port</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$dst_nickname</span><span class="s2">"</span>
            <span class="k">fi
        done
    done</span>

    <span class="c"># authorized_keys 보안</span>
    <span class="k">for</span> <span class="o">((</span><span class="nv">i</span><span class="o">=</span>0<span class="p">;</span> i&lt;<span class="k">${#</span><span class="nv">SERVER_LIST</span><span class="p">[@]</span><span class="k">}</span><span class="p">;</span> i++<span class="o">))</span>
    <span class="k">do
        </span><span class="nb">local </span><span class="nv">user</span><span class="o">=</span><span class="k">${</span><span class="p">!SERVER_LIST[i]</span>:0:1<span class="k">}</span>
        <span class="nb">local </span><span class="nv">ip</span><span class="o">=</span><span class="k">${</span><span class="p">!SERVER_LIST[i]</span>:1:1<span class="k">}</span>
        <span class="nb">local </span><span class="nv">passwd</span><span class="o">=</span><span class="k">${</span><span class="p">!SERVER_LIST[i]</span>:2:1<span class="k">}</span>
        <span class="nb">local </span><span class="nv">port</span><span class="o">=</span><span class="k">${</span><span class="p">!SERVER_LIST[i]</span>:3:1<span class="k">}</span>
        <span class="nb">local </span><span class="nv">nickname</span><span class="o">=</span><span class="k">${</span><span class="p">!SERVER_LIST[i]</span>:4:1<span class="k">}</span>

        set_authority <span class="s2">"</span><span class="nv">$user</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$ip</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$passwd</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$port</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$nickname</span><span class="s2">"</span>
    <span class="k">done</span>

    <span class="c"># 잘 접속되는지 최종 확인</span>
    <span class="k">for</span> <span class="o">((</span><span class="nv">i</span><span class="o">=</span>0<span class="p">;</span> i&lt;<span class="k">${#</span><span class="nv">SERVER_LIST</span><span class="p">[@]</span><span class="k">}</span><span class="p">;</span> i++<span class="o">))</span>
    <span class="k">do
        </span><span class="nb">local </span><span class="nv">src_user</span><span class="o">=</span><span class="k">${</span><span class="p">!SERVER_LIST[i]</span>:0:1<span class="k">}</span>
        <span class="nb">local </span><span class="nv">src_ip</span><span class="o">=</span><span class="k">${</span><span class="p">!SERVER_LIST[i]</span>:1:1<span class="k">}</span>
        <span class="nb">local </span><span class="nv">src_passwd</span><span class="o">=</span><span class="k">${</span><span class="p">!SERVER_LIST[i]</span>:2:1<span class="k">}</span>
        <span class="nb">local </span><span class="nv">src_port</span><span class="o">=</span><span class="k">${</span><span class="p">!SERVER_LIST[i]</span>:3:1<span class="k">}</span>
        <span class="nb">local </span><span class="nv">src_nickname</span><span class="o">=</span><span class="k">${</span><span class="p">!SERVER_LIST[i]</span>:4:1<span class="k">}</span>

        <span class="k">for</span> <span class="o">((</span><span class="nv">j</span><span class="o">=</span>0<span class="p">;</span> j&lt;<span class="k">${#</span><span class="nv">SERVER_LIST</span><span class="p">[@]</span><span class="k">}</span><span class="p">;</span> j++<span class="o">))</span>
        <span class="k">do
            </span><span class="nb">local </span><span class="nv">dst_user</span><span class="o">=</span><span class="k">${</span><span class="p">!SERVER_LIST[j]</span>:0:1<span class="k">}</span>
            <span class="nb">local </span><span class="nv">dst_ip</span><span class="o">=</span><span class="k">${</span><span class="p">!SERVER_LIST[j]</span>:1:1<span class="k">}</span>
            <span class="nb">local </span><span class="nv">dst_port</span><span class="o">=</span><span class="k">${</span><span class="p">!SERVER_LIST[j]</span>:3:1<span class="k">}</span>
            <span class="nb">local </span><span class="nv">dst_nickname</span><span class="o">=</span><span class="k">${</span><span class="p">!SERVER_LIST[j]</span>:4:1<span class="k">}</span>

            <span class="k">if</span> <span class="o">[[</span> <span class="s2">"</span><span class="k">${</span><span class="nv">src_ip</span><span class="k">}</span><span class="s2">:</span><span class="k">${</span><span class="nv">src_port</span><span class="k">}</span><span class="s2">"</span> <span class="o">!=</span> <span class="s2">"</span><span class="k">${</span><span class="nv">dst_ip</span><span class="k">}</span><span class="s2">:</span><span class="k">${</span><span class="nv">dst_port</span><span class="k">}</span><span class="s2">"</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
                </span>validate_ssh_conn <span class="s2">"</span><span class="nv">$src_user</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$src_ip</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$src_passwd</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$src_port</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$src_nickname</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$dst_user</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$dst_ip</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$dst_port</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$dst_nickname</span><span class="s2">"</span>
            <span class="k">fi
        done
    done</span>
<span class="o">}</span>


main

</code></pre></div></div>

<h2 id="client-java-설치">Client: Java 설치</h2>

<h3 id="bash_profile에-java-환경변수-등록">.bash_profile에 Java 환경변수 등록</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># .bash_profile</span>
<span class="nb">export </span><span class="nv">JAVA_HOME</span><span class="o">=</span>/Library/Java/JavaVirtualMachines/jdk1.8.0_202.jdk/Contents/Home
<span class="nb">export </span><span class="nv">JRE_HOME</span><span class="o">=</span><span class="k">${</span><span class="nv">JAVA_HOME</span><span class="k">}</span>/jre
</code></pre></div></div>

<h2 id="master-worker-java-설치">Master, Worker: Java 설치</h2>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>yum <span class="nb">install </span>java-1.8.0-openjdk <span class="nt">-y</span>

<span class="c"># java 어디에 설치되었는지 확인</span>
<span class="nv">$ </span><span class="nb">readlink</span> <span class="nt">-f</span> <span class="si">$(</span>which java<span class="si">)</span>
</code></pre></div></div>
<ul>
  <li>환경변수 등록</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>vi ~/.bashrc
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ~/.bashrc</span>
<span class="nv">JAVA_HOME</span><span class="o">=</span>/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.322.b06-1.el7_9.x86_64
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">source</span> ~/.bashrc
</code></pre></div></div>

<h2 id="master-worker-python-설치">Master, Worker: Python 설치</h2>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>yum <span class="nb">install </span>python3.6 <span class="nt">-y</span>
</code></pre></div></div>

<ul>
  <li>CentOS 7의 yum이 python2를 사용하기 때문에 좋은 방법은 아니지만, 일단 혼자 쓰는 거니까 편의상 python 명령어를 python2.7가 아닌 python3.6에 연결 (참고로 python3.6은 Spark 3.2.0에서 deprecated 됨)</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>update-alternatives <span class="nt">--install</span> /usr/bin/python python /usr/bin/python2.7 1
<span class="nv">$ </span><span class="nb">sudo </span>update-alternatives <span class="nt">--install</span> /usr/bin/python python /usr/bin/python3.6 2
<span class="nv">$ </span><span class="nb">sudo </span>update-alternatives <span class="nt">--config</span> python
</code></pre></div></div>

<ul>
  <li>pip 명령어도 pip2.7이 아닌 pip3.6에 연결</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo rm</span> /usr/bin/pip
<span class="nv">$ </span><span class="nb">sudo ln</span> <span class="nt">-s</span> /usr/bin/pip3.6 /usr/bin/pip
<span class="nv">$ </span>pip <span class="nt">-V</span>
</code></pre></div></div>

<h2 id="client-master-worker-spark-설치">Client, Master, Worker: Spark 설치</h2>

<h3 id="spark-다운로드">Spark 다운로드</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>wget https://dlcdn.apache.org/spark/spark-3.1.3/spark-3.1.3-bin-hadoop3.2.tgz
<span class="nv">$ </span><span class="nb">tar</span> <span class="nt">-xvzf</span> spark-3.1.3-bin-hadoop3.2.tgz
<span class="nv">$ </span><span class="nb">mv </span>spark-3.1.3-bin-hadoop3.2.tgz spark
</code></pre></div></div>

<h3 id="spark-환경변수-등록">Spark 환경변수 등록</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># MacOS</span>
vi ~/.bash_profile

<span class="c"># CentOS 7</span>
vi ~/.bashrc
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># MacOS(Client): ~/.bash_profile</span>
<span class="nb">export </span><span class="nv">BASE_DIR</span><span class="o">=</span>/Users/a
<span class="nb">export </span><span class="nv">SPARK_HOME</span><span class="o">=</span><span class="k">${</span><span class="nv">BASE_DIR</span><span class="k">}</span>/spark
<span class="nb">export </span><span class="nv">PYSPARK_PYTHON</span><span class="o">=</span>/opt/anaconda3/envs/pyspark/bin/python
<span class="nb">export </span><span class="nv">PYSPARK_DRIVER_PYTHON</span><span class="o">=</span>jupyter
<span class="nb">export </span><span class="nv">PYSPARK_DRIVER_PYTHON_OPTS</span><span class="o">=</span><span class="s1">'notebook'</span>

<span class="c"># CentOS 7(Master, Worker): ~/.bashrc</span>
<span class="nb">export </span><span class="nv">BASE_DIR</span><span class="o">=</span>/home/a
<span class="nb">export </span><span class="nv">SPARK_HOME</span><span class="o">=</span><span class="k">${</span><span class="nv">BASE_DIR</span><span class="k">}</span>/spark
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># MacOS</span>
<span class="nv">$ </span><span class="nb">source</span> ~/.bash_profile

<span class="c"># CentOS 7</span>
<span class="nv">$ </span><span class="nb">source</span>  ~/.bashrc
</code></pre></div></div>

<h3 id="spark-세부-설정-및-튜닝">Spark 세부 설정 및 튜닝</h3>
<ul>
  <li>물리적인 Worker가 9개, Worker들의 cores 수가 8개니까 대략적으로 Worker 당 instance 2개, instance 당 4 cores씩 배분하면 적절할 것으로 보임
    <ul>
      <li>SPARK_EXECUTOR_INSTANCES=18</li>
      <li>SPARK_EXECUTOR_CORES=4</li>
    </ul>
  </li>
  <li>물리적인 메모리는 Worker 당 32G인데, instance가 2개 뜨니까, 좀 여유남기고 13G 정도만 배정
    <ul>
      <li>SPARK_EXECUTOR_MEMORY=13G</li>
    </ul>
  </li>
  <li>SPARK_DRIVER_CORES는 cluster mode에서만 사용되고 기본값이 1인데 SPARK_EXECUTOR_CORES와 같게 하는 것이 일반적(권장), client 모드로만 쓸 예정이지만 혹시 몰라 지정해 둠
    <ul>
      <li>SPARK_DRIVER_CORES=4</li>
    </ul>
  </li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s1">'spark.master  spark://lab100:7077'</span> <span class="o">&gt;&gt;</span>  spark/conf/spark-defaults.conf
<span class="nb">echo</span> <span class="s1">'spark.serializer  org.apache.spark.serializer.KryoSerializer'</span> <span class="o">&gt;&gt;</span>  spark/conf/spark-defaults.conf

<span class="nb">echo</span> <span class="s1">'export SPARK_MASTER_IP="192.168.0.100"'</span> <span class="o">&gt;&gt;</span> spark/conf/spark-env.sh
<span class="nb">echo</span> <span class="s1">'export SPARK_MASTER_HOST=lab100'</span>  <span class="o">&gt;&gt;</span> spark/conf/spark-env.sh
<span class="nb">echo</span> <span class="s1">'export SPARK_MASTER_WEBUI_PORT=7777'</span>  <span class="o">&gt;&gt;</span> spark/conf/spark-env.sh
<span class="nb">echo</span> <span class="s1">'export SPARK_DRIVER_CORES=4'</span> <span class="o">&gt;&gt;</span> spark/conf/spark-env.sh
<span class="nb">echo</span> <span class="s1">'export SPARK_DRIVER_MEMORY=5G'</span> <span class="o">&gt;&gt;</span> spark/conf/spark-env.sh
<span class="nb">echo</span> <span class="s1">'export SPARK_EXECUTOR_INSTANCES=6'</span>  <span class="o">&gt;&gt;</span> spark/conf/spark-env.sh
<span class="nb">echo</span> <span class="s1">'export SPARK_EXECUTOR_CORES=4'</span>      <span class="o">&gt;&gt;</span> spark/conf/spark-env.sh
<span class="nb">echo</span> <span class="s1">'export SPARK_EXECUTOR_MEMORY=13G'</span>  <span class="o">&gt;&gt;</span> spark/conf/spark-env.sh
<span class="nb">echo</span> <span class="s1">'export SPARK_WORKER_DIR=$SPARK_HOME/work'</span> <span class="o">&gt;&gt;</span> spark/conf/spark-env.sh
<span class="nb">echo</span> <span class="s1">'export SPARK_LOG_DIR=$SPARK_HOME/logs'</span>   <span class="o">&gt;&gt;</span> spark/conf/spark-env.sh
<span class="nb">echo</span> <span class="s1">'export SPARK_PID_DIR=/tmp/spark/pid'</span>   <span class="o">&gt;&gt;</span> spark/conf/spark-env.sh
<span class="nb">echo</span> <span class="s1">'export SPARK_LOCAL_DIRS=/tmp/spark/scratch'</span>   <span class="o">&gt;&gt;</span> spark/conf/spark-env.sh

<span class="c"># echo 'export PYSPARK_PYTHON=/home/a/anaconda3/envs/pyspark/bin/python'   &gt;&gt; spark/conf/spark-env.sh</span>
<span class="c"># echo 'export PYSPARK_DRIVER_PYTHON=/home/a/anaconda3/envs/pyspark/bin/python'   &gt;&gt; spark/conf/spark-env.sh</span>

<span class="nb">echo</span> <span class="s1">'lab101'</span> <span class="o">&gt;&gt;</span> spark/conf/slaves
<span class="nb">echo</span> <span class="s1">'lab102'</span> <span class="o">&gt;&gt;</span> spark/conf/slaves
<span class="nb">echo</span> <span class="s1">'lab103'</span> <span class="o">&gt;&gt;</span> spark/conf/slaves
<span class="nb">echo</span> <span class="s1">'lab104'</span> <span class="o">&gt;&gt;</span> spark/conf/slaves
<span class="nb">echo</span> <span class="s1">'lab105'</span> <span class="o">&gt;&gt;</span> spark/conf/slaves
<span class="nb">echo</span> <span class="s1">'lab106'</span> <span class="o">&gt;&gt;</span> spark/conf/slaves
<span class="nb">echo</span> <span class="s1">'lab107'</span> <span class="o">&gt;&gt;</span> spark/conf/slaves
<span class="nb">echo</span> <span class="s1">'lab108'</span> <span class="o">&gt;&gt;</span> spark/conf/slaves
<span class="nb">echo</span> <span class="s1">'lab109'</span> <span class="o">&gt;&gt;</span> spark/conf/slaves
</code></pre></div></div>

<h2 id="master-spark-cluster-실행">Master: Spark Cluster 실행</h2>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 시작</span>
<span class="nv">$ </span>spark/sbin/start-all.sh

<span class="c"># 중지</span>
<span class="nv">$ </span>spark/sbin/stop-all.sh
</code></pre></div></div>

<ul>
  <li>
    <SPARK_MASTER_IP>:<SPARK_MASTER_WEBUI_PORT>로 접속하여 spark cluster가 잘 구성되었는지 확인
</SPARK_MASTER_WEBUI_PORT></SPARK_MASTER_IP>
    <ul>
      <li>http://192.168.0.100:7777</li>
    </ul>
  </li>
</ul>

<h2 id="client-jupyter-notebook-세팅">Client: Jupyter Notebook 세팅</h2>
<ul>
  <li>Client에서는 편의상 Conda로 Python을 관리</li>
</ul>

<h3 id="jupyter-notebook-설치">Jupyter Notebook 설치</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>pip <span class="nb">install </span>jupyterlab
<span class="nv">$ </span>pip <span class="nb">install </span>jupyternotebook
</code></pre></div></div>

<h3 id="jupyter-notebook-원격-접속-설정">Jupyter Notebook 원격 접속 설정</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>jupyter-lab <span class="nt">--generate-config</span>
<span class="nv">$ </span>jupyter notebook <span class="nt">--generate-config</span>

<span class="nv">$ </span>vi ~/.jupyter/jupyter_notebook_config.py
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ~/.jupyter/jupyter_notebook_config.py</span>
c <span class="o">=</span> get_config<span class="o">()</span>

c.NotebookApp.allow_origin <span class="o">=</span> <span class="s1">'*'</span>
c.NotebookApp.ip <span class="o">=</span> <span class="s1">'*'</span>

<span class="c"># Port 변경</span>
c.NotebookApp.port <span class="o">=</span> 9988

<span class="c"># 창으로 바로 안뜨게</span>
c.NotebookApp.open_browser <span class="o">=</span> False

<span class="c"># jupyter 시작 위치 설정</span>
c.NotebookApp.notebook_dir <span class="o">=</span> <span class="s1">'/Users/a'</span>

<span class="c"># 패스워드 설정: 이건 여기선 안함, 실행 명령어에 옵션으로 지정할 예정</span>
<span class="c"># c.NotebookApp.password_required = True</span>
<span class="c"># c.NotebookApp.password = ''</span>
</code></pre></div></div>

<h3 id="conda-pyspark-kernel-생성">Conda pyspark kernel 생성</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>conda create <span class="nt">-n</span> pyspark <span class="nv">python</span><span class="o">=</span>3.6 anaconda

<span class="nv">$ </span>conda activate pyspark

<span class="o">(</span>pyspark<span class="o">)</span><span class="nv">$ </span>which python
/opt/anaconda3/envs/pyspark/bin/python
</code></pre></div></div>

<h3 id="sparksql-magic-설치">sparksql-magic 설치</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>pyspark<span class="o">)</span><span class="nv">$ </span>pip <span class="nb">install </span>sparksql-magic
</code></pre></div></div>

<h4 id="sparksql-magic-사용법">sparksql-magic 사용법</h4>
<ul>
  <li>jupyter notebook 셀에서</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>%load_ext sparksql_magic
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>%%sparksql
SELECT <span class="k">*</span> FROM dfTable
</code></pre></div></div>

<h3 id="conda-pyspark-kernel-설정">Conda pyspark kernel 설정</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># /home/a/anaconda3/envs/pyspark/share/jupyter/kernels/python3/kernel.json</span>
<span class="nv">$ </span>vi ~/Library/Jupyter/kernels/pyspark/kernel.json
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">{</span>
 <span class="s2">"argv"</span>: <span class="o">[</span>
  <span class="s2">"/opt/anaconda3/envs/pyspark/bin/python"</span>,
  <span class="s2">"-m"</span>,
  <span class="s2">"ipykernel_launcher"</span>,
  <span class="s2">"-f"</span>,
  <span class="s2">"{connection_file}"</span>
 <span class="o">]</span>,
 <span class="s2">"display_name"</span>: <span class="s2">"pyspark"</span>,
 <span class="s2">"language"</span>: <span class="s2">"python"</span>,
 <span class="s2">"env"</span>: <span class="o">{</span>
    <span class="s2">"SPARK_HOME"</span>: <span class="s2">"/Users/a/spark"</span>,
    <span class="s2">"PYTHONPATH"</span>: <span class="s2">"/Users/a/spark/python/:/Users/a/spark/python/lib/py4j-0.10.9.3-src.zip:/Users/a/spark/python/lib/pyspark.zip"</span>,
    <span class="s2">"PYSPARK_PYTHON"</span>: <span class="s2">"/usr/bin/python"</span>,
    <span class="s2">"PYSPARK_DRIVER_PYTHON"</span>: <span class="s2">"jupyter"</span>,
    <span class="s2">"PYSPARK_DRIVER_PYTHON_OPTS"</span>: <span class="s2">"notebook"</span>,
    <span class="s2">"PYTHONSTARTUP"</span>: <span class="s2">"/Users/a/spark/python/pyspark/shell.py"</span>,
    <span class="s2">"PYSPARK_SUBMIT_ARGS"</span>: <span class="s2">"--master=spark://&lt;SPARK_MASTER_IP&gt;:&lt;SPARK_MASTER_PORT&gt; --name 'pyspark.jupyter' --packages org.apache.hadoop:hadoop-aws:3.1.3,com.amazonaws:aws-java-sdk-bundle:1.11.563,com.google.guava:guava:27.1-jre  --deploy-mode client pyspark-shell"</span>
 <span class="o">}</span>
</code></pre></div></div>

<h3 id="시작-시-자동-import-설정">시작 시 자동 import 설정</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ipython profile create
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[ProfileCreate] Generating default config file: '/home/a/.ipython/profile_default/ipython_config.py'
[ProfileCreate] Generating default config file: '/home/a/.ipython/profile_default/ipython_kernel_config.py'
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>vi /home/a/.ipython/profile_default/startup/00-first_.py
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import pandas as pd
import numpy as np
</code></pre></div></div>

<h3 id="jupyter-notebook-실행-script-start-labsh">Jupyter Notebook 실행 Script: start-lab.sh</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nv">JUPYTER_PASSWORD</span><span class="o">=</span>&lt;JUPYTER_PASSWORD&gt;

<span class="nb">source</span> /opt/anaconda3/etc/profile.d/conda.sh
conda activate pyspark
jupyter-lab <span class="nt">--ip</span> 0.0.0.0 <span class="nt">--port</span> &lt;JUPYTER_PORT&gt; <span class="nt">--NotebookApp</span>.password<span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="nv">$JUPYTER_PASSWORD</span> | python3 <span class="nt">-c</span> <span class="s1">'from IPython.lib.security import passwd;print(passwd(input()))'</span><span class="si">)</span> <span class="nt">--allow-root</span> <span class="nt">--no-browser</span> &amp;
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bash start-lab.sh
</code></pre></div></div>

  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="safenumz/blog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/blog/architecture/2022/05/01/spark-cluster-jupyter.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/blog/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/blog/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/blog/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>AI and Data Engineering</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/fastai" target="_blank" title="fastai"><svg class="svg-icon grey"><use xlink:href="/blog/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/fastdotai" target="_blank" title="fastdotai"><svg class="svg-icon grey"><use xlink:href="/blog/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
